<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=0">
	<title>title</title>
	<link href="styles.css" rel="stylesheet">
</head>

<body>
	<div id="top-nav"></div>
	<div id="content"></div>
	<div id="log"></div>
	<script defer src="Card.js"></script>
	<script defer src="controller.js"></script>
	<script>

class Sketchpad extends HTMLCanvasElement {
  constructor() {
    super();
    this.activeTouches = new Map();
    this.activePointer = null;
    this.pointerWidth = 1;
    this.pointerColor = '#000';
    this.addEventListener('touchstart', this.touchstart.bind(this));
    this.addEventListener('touchmove', this.touchmove.bind(this));
  }

  touchstart(evt) {
    const Log = document.getElementById('log');
    Log.innerHTML = 'touchstart: ' + JSON.stringify(evt.changedTouches);
    evt.preventDefault();
    this.activeTouches.clear();
    const ctx = this.getContext('2d');
    ctx.fillStyle = this.pointerColor;

    let i = 0;
    while (i < evt.changedTouches.length) {
      const { identifier, clientX, clientY } = evt.changedTouches[i];
      this.activeTouches.set(identifier,  { clientX, clientY });
      ctx.beginPath();
      ctx.arc(this.gridX(clientX), this.gridY(clientY), 0.5*this.pointerWidth, 0, 2*Math.PI, false);
      ctx.fill();
      i++;
    }
  }

  touchmove(evt) {
    const Log = document.getElementById('log');
    Log.innerHTML = 'touchmove: ' + JSON.stringify(evt.changedTouches);
    evt.preventDefault();
    const ctx = this.getContext('2d');
    ctx.fillStyle = this.pointerColor;

    let i = 0;
    while (i < evt.changedTouches.length) {
      const { identifier, clientX: clientX_next, clientY: clientY_next } = evt.changedTouches[i];
      const point_prev = this.activeTouches.get(identifier); 

      if (point_prev) {
        ctx.beginPath();
        ctx.moveTo(this.gridX(point_prev.clientX), this.gridY(point_prev.clientY));
        ctx.lineTo(this.gridX(clientX_next), this.gridY(clientY_next));
        ctx.stroke();

        this.activeTouches.set(identifier, {
          clientX: clientX_next,
          clientY: clientY_next
        });
      }

      i++;
    }
  }

  gridX(pointer_x) {
    const { x } = this.getBoundingClientRect();
    return (pointer_x - x) + this.scrollLeft;
  }

  gridY(pointer_y) {
    const { y } = this.getBoundingClientRect();
    return (pointer_y - y) + this.scrollTop;
  }

  updateDimensions() {
    this.width = this.scrollWidth;
    this.height = this.scrollHeight;
  }

  connectedCallback() {
    this.updateDimensions();
  }

  static get observedAttributes() {
    return ['scrollWidth', 'scrollHeight'];
  }

  attributeChangedCallback(name, oldValue, newValue) {
    switch(name) {
      case 'scrollWidth':
        this.width = newValue;
        break;
      case 'scrollHeight':
        this.height = newValue;
        break;
    }
  }
}
		function autorun() {
			customElements.define('sketch-pad', Sketchpad, { extends: 'canvas'});
			initTopNav();
		}

		if (document.addEventListener) document.addEventListener("DOMContentLoaded", autorun, false);
		else if (document.attachEvent) document.attachEvent("onreadystatechange", autorun);
		else window.onload = autorun;

		function initTopNav() {
			const [Purge, Create, Study, Draw] = topNavActions = [
				document.createElement('input'),
				document.createElement('input'),
				document.createElement('input'),
				document.createElement('input')
			];

			Purge.value = 'clear all';
			Create.value = 'create';
			Study.value = 'study';
			Draw.value = 'draw';

			const P = document.getElementById('top-nav');

			topNavActions.forEach((b) => {
				b.type = 'button';
				b.className += 'topnav-action';
				P.appendChild(b);
			});

			const makeACard = initMakeACard.bind(null, clearPage);
			const study = initStudy.bind(null, clearPage, loadCards);

			Purge.addEventListener('click', () => window.confirm('Confirm Purge') ? purge(): null);
			Create.addEventListener('click', makeACard);
			Study.addEventListener('click', study);
			Draw.addEventListener('click', initDraw);

			document.getElementById('top-nav').appendChild(Create);
			document.getElementById('top-nav').appendChild(Study);
			document.getElementById('top-nav').appendChild(Draw);
		}

		function initDraw() {
			const container = document.getElementById('content');
			container.innerHTML = '';
			const sketchpad = document.createElement('canvas', { is: 'sketch-pad' });
			sketchpad.setAttribute('id', 'draw');
			container.appendChild(sketchpad);

			const Log = document.getElementById('log');
			sketchpad.addEventListener('touchstart', function() {
				Log.innerHTML = JSON.stringify(sketchpad);
			});
		}

		function initMakeACard(...pretasks) {
			const e = pretasks.pop();
			pretasks.forEach((t) => t());
			
			const formData = {
				front: '',
				back: ''
			};
			const form = document.createElement('form');
			form.setAttribute('id', 'make-a-card');
			const front = document.createElement('textarea');
			front.name = 'front';
			front.placeholder = 'Front';
			const back = document.createElement('textarea');
			back.name = 'back';
			back.placeholder = 'Back';
			
			[front, back].forEach((d) => {
				d.className += 'text-box';
				form.appendChild(d);
			});

			const Submit = document.createElement('button');
			Submit.setAttribute('id', 'submit');
			Submit.innerText = 'add';
			Submit.type = 'Submit';
			form.appendChild(Submit);
			form.onsubmit = function(e) {
				e.preventDefault();
				Object.keys(formData).map((key) => {
					formData[key] = e.target.elements[key].value;
				});

				addOrUpdateCard(formData)
					.then(confirmation);
			};

			document.getElementById('content').appendChild(form);

			function confirmation() {
				const canvas = document.createElement('canvas');
				canvas.setAttribute('width', 150);
				canvas.setAttribute('height', 150);
				const content = document.getElementById('content');
				content.innerHTML = '';
				content.appendChild(canvas);

				const ctx = canvas.getContext('2d');
				const ring = new Path2D();
				ring.arc(75, 75, 75, 0, Math.PI * 2);
				ring.arc(75, 75, 62.5, 0, Math.PI * 2);
				ctx.fillStyle = 'green';
				ctx.fill(ring, 'evenodd');

				ctx.translate(75, 75);
				ctx.rotate(Math.PI / 4);
				ctx.translate(-75, -75);

				const check = new Path2D();
				check.moveTo(45, 92.5);
				check.lineTo(45, 105);
				check.lineTo(95, 105);
				check.lineTo(95, 30.5);
				check.lineTo(82.5, 30.5);
				check.lineTo(82.5, 92.5);
				check.closePath();

				ctx.fill(check);
			}
		}

		function initStudy(...pretasks) {
			const e = pretasks.pop();
			pretasks.forEach((t) => t());
			let whichCard = JSON.parse(sessionStorage.getItem('whichCard'));
			let cardData = sessionStorage.getItem(whichCard);
			if (!cardData) {
				return;
			}
			let card = new Card(JSON.parse(cardData));
			let cardFace = 'front';

			const display = document.createElement('div'); 
			display.setAttribute('id', 'card-face');
			display.innerText = card[cardFace];

			const content = document.getElementById('content');
			content.appendChild(display);

			const flipButton = document.createElement('button');
			flipButton.setAttribute('id', 'flip');
			flipButton.onclick = flip;
			flipButton.innerText = 'flip';

			content.appendChild(flipButton);

			const prev = document.createElement('button');
			prev.setAttribute('id', 'prev');
			prev.onclick = shift.bind(null, -1);
			prev.innerText = 'previous';

			const next = document.createElement('button');
			next.setAttribute('id', 'next');
			next.onclick = shift.bind(null, 1);
			next.innerText = 'next';

			content.appendChild(prev);
			content.appendChild(next);

			/**
			*/
			let flipping = false;
			function flip() {
				if (flipping) return;
				flipping = true;
				cardFace = cardFace === 'front' ? 'back': 'front';
				display.innerText = card[cardFace];
				flipping = false;
			}

			/**
			 */ 
			let shifting = false;
			function shift(direction) {
				if (shifting) return;
				shifting = true;

				whichCard += direction;
				if (!sessionStorage.getItem(whichCard)) {
					whichCard = 0;
				}

			  let cardData = sessionStorage.getItem(whichCard);
			  if (!cardData) {
			  	return;
			  }
			  card = new Card(JSON.parse(cardData));
			  cardFace = 'front';
			  display.innerText = card[cardFace];
				sessionStorage.setItem('whichCard', whichCard);

				shifting = false;
			}
		}

		function clearPage() {
			document.getElementById('content').innerHTML = '';
		}

		function loadCards() {
			const cards = getCard(); 
			cards.forEach((c, index) => sessionStorage.setItem(index, JSON.stringify(c)));
			sessionStorage.setItem('whichCard', 0);
		}

		function purge() {
			localStorage.removeItem('FlC card storage');
		}
	</script>
</body>

</html>
