<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>title</title>
	<style>
		#top-nav {
			display: flex;
			flex-direction: row;
			justify-content: flex-end;
		}

		#top-nav .topnav-action+.topnav-action {
			margin-left: 1em;
		}

		#make-a-card form {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		#make-a-card form > * + * {
			margin-top: 1em;
		}

		#make-a-card form .bordered {
			border: 1px solid black;
			pointer-events: none;
			user-select: none;
		}

		#content {
			position: relative;
		}

		#card-face {
			border: 2px solid #333333;
			height: 33em;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		#flip {
			position: absolute;
			top: 0;
			right: 0;
		}
	</style>
</head>

<body>
	<div id="top-nav"></div>
	<div id="content"></div>
	<script src="Card.js"></script>
	<script src="controller.js"></script>
	<script>
		function autorun() {
			initTopNav();
		}

		if (document.addEventListener) document.addEventListener("DOMContentLoaded", autorun, false);
		else if (document.attachEvent) document.attachEvent("onreadystatechange", autorun);
		else window.onload = autorun;

		function initTopNav() {
			const [Create, Study] = topNavActions = [
				document.createElement('input'),
				document.createElement('input')
			];

			Create.value = 'create';
			Study.value = 'study';

			const P = document.getElementById('top-nav');

			topNavActions.forEach((b) => {
				b.type = 'button';
				b.className += 'topnav-action';
				P.appendChild(b);
			});

			const makeACard = initMakeACard.bind(null, clearPage);
			const study = initStudy.bind(null, clearPage, loadCards);

			Create.addEventListener('click', makeACard);
			Study.addEventListener('click', study);

			document.getElementById('top-nav').appendChild(Create);
			document.getElementById('top-nav').appendChild(Study);
		}

		function initMakeACard(...pretasks) {
			const e = pretasks.pop();
			pretasks.forEach((t) => t());
			
			const formData = {
				front: '',
				back: ''
			};
			const form = document.createElement('form');
			const front = document.createElement('textarea');
			front.name = 'front';
			const back = document.createElement('textarea');
			back.name = 'back';
			
			[front, back].forEach((d) => {
				d.className += 'text-box';
			});
			
			const frontLabel = document.createElement('label');
			const f_label_text = document.createElement('div'); 	 
			f_label_text.innerText = 'front';
			
			const backLabel = document.createElement('label');
			const b_label_text = document.createElement('div');
			b_label_text.innerText = 'back';

			[f_label_text, b_label_text].forEach((d) => d.className+= 'bordered');

			frontLabel.appendChild(f_label_text);
			frontLabel.appendChild(front);

			backLabel.appendChild(b_label_text);
			backLabel.appendChild(back);

			[frontLabel, backLabel].forEach((d) => form.appendChild(d));

			const Submit = document.createElement('button');
			Submit.innerText = 'add';
			Submit.type = 'Submit';
			form.appendChild(Submit);
			form.onsubmit = function(e) {
				e.preventDefault();
				Object.keys(formData).map((key) => {
					formData[key] = e.target.elements[key].value;
				});

				addOrUpdateCard(formData);
			};

			document.getElementById('content').appendChild(form);
		}

		function initStudy(...pretasks) {
			const e = pretasks.pop();
			pretasks.forEach((t) => t());
			let whichCard = JSON.parse(sessionStorage.getItem('whichCard'));
			let cardData = sessionStorage.getItem(whichCard);
			if (!cardData) {
				return;
			}
			let card = new Card(JSON.parse(cardData));
			let cardFace = 'front';

			const display = document.createElement('div'); 
			display.setAttribute('id', 'card-face');
			display.innerText = card[cardFace];

			const content = document.getElementById('content');
			content.appendChild(display);

			const flipButton = document.createElement('button');
			flipButton.setAttribute('id', 'flip');
			flipButton.onclick = flip;
			flipButton.innerText = 'flip';

			content.appendChild(flipButton);

			const prev = document.createElement('button');
			prev.setAttribute('id', 'prev');
			prev.onclick = shift.bind(null, -1);
			prev.innerText = 'previous';

			const next = document.createElement('button');
			next.setAttribute('id', 'next');
			next.onclick = shift.bind(null, 1);
			next.innerText = 'next';

			content.appendChild(prev);
			content.appendChild(next);

			/**
			*/
			let flipping = false;
			function flip() {
				if (flipping) return;
				flipping = true;
				cardFace = cardFace === 'front' ? 'back': 'front';
				display.innerText = card[cardFace];
				flipping = false;
			}

			/**
			 */ 
			let shifting = false;
			function shift(direction) {
				if (shifting) return;
				shifting = true;

				whichCard += direction;
				if (!sessionStorage.getItem(whichCard)) {
					whichCard = 0;
				}

			  let cardData = sessionStorage.getItem(whichCard);
			  if (!cardData) {
			  	return;
			  }
			  card = new Card(JSON.parse(cardData));
			  cardFace = 'front';
			  display.innerText = card[cardFace];
				sessionStorage.setItem('whichCard', whichCard);

				shifting = false;
			}
		}

		function clearPage() {
			document.getElementById('content').innerHTML = '';
		}

		function loadCards() {
			const cards = getCard(); 
			cards.forEach((c, index) => sessionStorage.setItem(index, JSON.stringify(c)));
			sessionStorage.setItem('whichCard', 0);
		}
	</script>
</body>

</html>
